---
# rpm-ostree Repository Setup Playbook
# Version: 2.0.0
# Last Updated: 2026-01-26
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/setup-rpm-ostree-repo.yml
#
# Prerequisites:
#   - Apache must already be installed and running (from Flatpak repo setup)
#   - SSL certificates must exist (if HTTPS enabled)
#
# This playbook will automatically install:
#   - ostree
#   - rpm-ostree

- name: Setup rpm-ostree Repository Server
  hosts: rpm_ostree_repo_servers
  become: yes

  pre_tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Starting rpm-ostree Repository Setup"
          - "========================================"
          - "This will extend your existing Apache server"
          - "to serve rpm-ostree content for Kinoite"

    - name: Install required packages
      ansible.builtin.package:
        name:
          - ostree
          - rpm-ostree
        state: present
      register: package_install

    - name: Display package installation result
      ansible.builtin.debug:
        msg: "Required packages installed successfully"
      when: package_install.changed

  roles:
    - role: rpm_ostree_repo
      tags: [repository, setup]

    - role: rpm_ostree_fedora_repos
      tags: [repos, setup]

    - role: rpm_ostree_selinux
      tags: [selinux, security, setup]

    - role: rpm_ostree_apache
      tags: [apache, web, setup]

    - role: rpm_ostree_firewall
      tags: [firewall, security, setup]

    - role: rpm_ostree_compose
      tags: [compose, image, setup]

  post_tasks:
    - name: Display setup completion message
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "rpm-ostree Repository Setup Complete!"
          - "========================================"
          - "DEV Repository Path: {{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}"
          - "PROD Repository Path: {{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}"
          - "DEV HTTP Alias: {{ rpm_ostree_http_alias_dev | default('/repo/kinoite/dev') }}"
          - "PROD HTTP Alias: {{ rpm_ostree_http_alias_prod | default('/repo/kinoite/prod') }}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}HTTPS Enabled: YES{% else %}HTTPS Enabled: NO{% endif %}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}DEV Repository URL: https://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_https_port | default('8443') }}{{ rpm_ostree_http_alias_dev | default('/repo/kinoite/dev') }}{% else %}DEV Repository URL: http://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_http_port | default('8080') }}{{ rpm_ostree_http_alias_dev | default('/repo/kinoite/dev') }}{% endif %}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}PROD Repository URL: https://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_https_port | default('8443') }}{{ rpm_ostree_http_alias_prod | default('/repo/kinoite/prod') }}{% else %}PROD Repository URL: http://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_http_port | default('8080') }}{{ rpm_ostree_http_alias_prod | default('/repo/kinoite/prod') }}{% endif %}"
          - ""
          - "Treefiles are deployed at /etc/rpm-ostree/treefiles/"
          - "See compose role output above for composition instructions"
          - ""
          - "On Kinoite clients, add the remote:"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}  sudo ostree remote add --no-gpg-verify kinoite-dev https://SERVER:8443{{ rpm_ostree_http_alias_dev | default('/repo/kinoite/dev') }}{% else %}  sudo ostree remote add --no-gpg-verify kinoite-dev http://SERVER:8080{{ rpm_ostree_http_alias_dev | default('/repo/kinoite/dev') }}{% endif %}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}  sudo ostree remote add --no-gpg-verify kinoite-prod https://SERVER:8443{{ rpm_ostree_http_alias_prod | default('/repo/kinoite/prod') }}{% else %}  sudo ostree remote add --no-gpg-verify kinoite-prod http://SERVER:8080{{ rpm_ostree_http_alias_prod | default('/repo/kinoite/prod') }}{% endif %}"
          - "Then rebase to your custom image:"
          - "  sudo rpm-ostree rebase kinoite-dev:fedora/x86_64/kinoite/dev"
          - "  sudo rpm-ostree rebase kinoite-prod:fedora/x86_64/kinoite/stable"
      tags: [always]
