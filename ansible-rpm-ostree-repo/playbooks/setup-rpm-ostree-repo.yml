---
# rpm-ostree Repository Setup Playbook
# Version: 2.0.0
# Last Updated: 2026-01-26
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/setup-rpm-ostree-repo.yml
#
# Prerequisites:
#   - Apache must already be installed and running (from Flatpak repo setup)
#   - SSL certificates must exist (if HTTPS enabled)
#
# This playbook will automatically install:
#   - ostree
#   - rpm-ostree

- name: Setup rpm-ostree Repository Server
  hosts: rpm_ostree_repo_servers
  become: yes

  pre_tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Starting rpm-ostree Repository Setup"
          - "========================================"
          - "This will extend your existing Apache server"
          - "to serve rpm-ostree content for Kinoite"

    - name: Install required packages
      ansible.builtin.package:
        name:
          - ostree
          - rpm-ostree
        state: present
      register: package_install

    - name: Display package installation result
      ansible.builtin.debug:
        msg: "Required packages installed successfully"
      when: package_install.changed

  roles:
    - role: rpm_ostree_repo
      tags: [repository, setup]

    - role: rpm_ostree_selinux
      tags: [selinux, security, setup]

    - role: rpm_ostree_apache
      tags: [apache, web, setup]

    - role: rpm_ostree_firewall
      tags: [firewall, security, setup]

    - role: rpm_ostree_compose
      tags: [compose, image, setup]

  post_tasks:
    - name: Display setup completion message
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "rpm-ostree Repository Setup Complete!"
          - "========================================"
          - "Repository Path: {{ rpm_ostree_repo_path }}"
          - "HTTP Alias: {{ rpm_ostree_http_alias }}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}HTTPS Enabled: YES{% else %}HTTPS Enabled: NO{% endif %}"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}Repository URL: https://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_https_port | default('8443') }}{{ rpm_ostree_http_alias }}{% else %}Repository URL: http://{{ ansible_default_ipv4.address }}:{{ hostvars[inventory_hostname].flatpak_repo_http_port | default('8080') }}{{ rpm_ostree_http_alias }}{% endif %}"
          - ""
          - "Next Steps:"
          - "1. Create a treefile for Kinoite (e.g., kinoite.json)"
          - "2. Compose your first image:"
          - "   sudo rpm-ostree compose tree --repo={{ rpm_ostree_repo_path }} kinoite.json"
          - "3. Update the repository summary:"
          - "   sudo ostree summary -u --repo={{ rpm_ostree_repo_path }}"
          - "4. On Kinoite clients, add the remote:"
          - "{% if rpm_ostree_enable_https | default(false) | bool %}   sudo ostree remote add --no-gpg-verify kinoite https://SERVER:8443{{ rpm_ostree_http_alias }}{% else %}   sudo ostree remote add --no-gpg-verify kinoite http://SERVER:8080{{ rpm_ostree_http_alias }}{% endif %}"
          - "5. Rebase to your custom image:"
          - "   sudo rpm-ostree rebase kinoite:fedora/x86_64/kinoite/stable"
      tags: [always]
