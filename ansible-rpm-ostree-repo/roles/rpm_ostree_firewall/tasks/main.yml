---
# Firewall Configuration Role for rpm-ostree
# Version: 1.0.0
# Last Updated: 2026-01-26
# Purpose: Configure firewall for rpm-ostree repository access

- name: Check if firewalld is installed and active
  ansible.builtin.systemd:
    name: firewalld
  register: firewalld_status
  failed_when: false

- name: Open HTTP port in firewall
  ansible.posix.firewalld:
    port: "{{ flatpak_repo_http_port | default('8080') }}/tcp"
    permanent: yes
    immediate: yes
    state: enabled
  when:
    - firewalld_status.status is defined
    - firewalld_status.status.ActiveState == "active"

- name: Verify HTTP port is open in firewall
  ansible.posix.firewalld:
    port: "{{ flatpak_repo_http_port | default('8080') }}/tcp"
    permanent: yes
    immediate: yes
    state: enabled
  when:
    - firewalld_status.status is defined
    - firewalld_status.status.ActiveState == "active"

- name: Verify HTTPS port is open in firewall
  ansible.posix.firewalld:
    port: "{{ flatpak_repo_https_port | default('8443') }}/tcp"
    permanent: yes
    immediate: yes
    state: enabled
  when:
    - firewalld_status.status is defined
    - firewalld_status.status.ActiveState == "active"
    - rpm_ostree_enable_https | default(true) | bool

- name: Display firewall configuration
  ansible.builtin.debug:
    msg:
      - "Firewall configured for rpm-ostree repository"
      - "Note: rpm-ostree shares ports with Flatpak repository"
      - "HTTP port {{ flatpak_repo_http_port | default('8080') }}/tcp verified"
      - "{% if rpm_ostree_enable_https | default(true) | bool %}HTTPS port {{ flatpak_repo_https_port | default('8443') }}/tcp verified{% endif %}"
  when:
    - firewalld_status.status is defined
    - firewalld_status.status.ActiveState == "active"

- name: Display firewall not active message
  ansible.builtin.debug:
    msg: "Firewalld is not active, skipping firewall configuration. Ensure ports are open: HTTP {{ flatpak_repo_http_port | default('8080') }}, HTTPS {{ flatpak_repo_https_port | default('8443') }}"
  when:
    - firewalld_status.status is not defined or firewalld_status.status.ActiveState != "active"
