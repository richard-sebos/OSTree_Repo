---
# rpm-ostree Repository Initialization Role
# Version: 2.0.0
# Last Updated: 2026-01-26
# Purpose: Initialize and configure rpm-ostree repositories (dev and prod)

- name: Create base rpm-ostree directory
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_base_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create dev repository directory
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create prod repository directory
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Check if dev repository is already initialized
  ansible.builtin.stat:
    path: "{{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}/config"
  register: repo_config_dev

- name: Check if prod repository is already initialized
  ansible.builtin.stat:
    path: "{{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}/config"
  register: repo_config_prod

- name: Initialize dev OSTree repository
  ansible.builtin.command:
    cmd: ostree init --mode={{ rpm_ostree_repo_mode | default('archive-z2') }} --repo={{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}
  when: not repo_config_dev.stat.exists

- name: Initialize prod OSTree repository
  ansible.builtin.command:
    cmd: ostree init --mode={{ rpm_ostree_repo_mode | default('archive-z2') }} --repo={{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}
  when: not repo_config_prod.stat.exists

- name: Set dev repository permissions
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
    recurse: yes

- name: Set prod repository permissions
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
    recurse: yes

- name: Display repository information
  ansible.builtin.debug:
    msg:
      - "rpm-ostree repositories initialized:"
      - "  DEV:  {{ rpm_ostree_repo_dev_path | default(rpm_ostree_repo_base_path ~ '/dev') }}"
      - "  PROD: {{ rpm_ostree_repo_prod_path | default(rpm_ostree_repo_base_path ~ '/prod') }}"
      - "Repository mode: {{ rpm_ostree_repo_mode | default('archive-z2') }}"
      - "Ready for composing Kinoite images in dev and prod"
