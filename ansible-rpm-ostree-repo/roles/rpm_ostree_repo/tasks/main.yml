---
# rpm-ostree Repository Initialization Role
# Version: 1.0.0
# Last Updated: 2026-01-25
# Purpose: Initialize and configure rpm-ostree repository for Kinoite

- name: Create base rpm-ostree directory
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_base_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create repository directory
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Check if repository is already initialized
  ansible.builtin.stat:
    path: "{{ rpm_ostree_repo_path }}/config"
  register: repo_config

- name: Initialize OSTree repository for rpm-ostree
  ansible.builtin.command:
    cmd: ostree init --mode={{ rpm_ostree_repo_mode }} --repo={{ rpm_ostree_repo_path }}
  when: not repo_config.stat.exists

- name: Set repository permissions
  ansible.builtin.file:
    path: "{{ rpm_ostree_repo_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
    recurse: yes

- name: Display repository information
  ansible.builtin.debug:
    msg:
      - "rpm-ostree repository initialized at {{ rpm_ostree_repo_path }}"
      - "Repository mode: {{ rpm_ostree_repo_mode }}"
      - "Ready for composing Kinoite images"
